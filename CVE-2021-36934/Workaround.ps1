Import-Module $env:SyncroModule
$ErrorActionPreference = "SilentlyContinue";

if ((get-acl C:\windows\system32\config\sam).Access | 
    ? IdentityReference -match 'BUILTIN\\Users' | 
    select -expandproperty filesystemrights | 
    select-string 'Read') {
    write-host "May be vulnerable: Arbitrary Read permissions for SAM file"
    Set-Asset-Field -Name "CVE-2021-36934" -Value true
    #https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934
    icacls C:\windows\system32\config\*.* /inheritance:e
    vssadmin delete shadows /for=c: /all /quiet
    Checkpoint-Computer -Description "CVE-2021-36934" -RestorePointType "MODIFY_SETTINGS"
}
else {
    write-host "Does not seem to be vulnerable, SAM permissions are fine"
    Set-Asset-Field -Name "CVE-2021-36934" -Value false 
}
